# API v1 Interface Contract (Draft)
_Last updated: 2026-02-27 06:37 UTC_

This document defines the **API v1** contract for the interactive storybook system.
It is designed to be appended after your **Story System Architecture v1.0 (Production Spec)** section.

---

## Conventions

### Base URL
- `/api/v1`

### Content Type
- Requests: `Content-Type: application/json`
- Responses: `application/json`

### IDs & Versioning
- `story_id`: generated by backend after `/story/generate`
- `previous_story_id`: client passes the story id it wants to regenerate from
- `client_session_token`: UUID generated by client before starting reading; used for idempotency
- `session_id`: generated by backend in `/session/start`
- `event_id`: UUID generated per telemetry event; used for de-duplication
- `schema_version`: for story JSON and telemetry schemas (e.g., `"story-1.0.0"`, `"telemetry-1.0.0"`)

### Idempotency & De-duplication (Hard Rules)
- `/session/start` must be idempotent on `(story_id, client_session_token)`
- `/telemetry/report` must de-duplicate by `event_id`

### Error Format (Unified)
All non-2xx responses MUST follow:
```json
{
  "error": {
    "code": "STRING_CODE",
    "message": "Human readable message",
    "details": {}
  }
}
```

### Common Error Codes
- `400` `BAD_REQUEST` – invalid parameters / missing required fields
- `401` `UNAUTHORIZED` – auth missing/invalid (if enabled)
- `404` `NOT_FOUND` – story/session not found
- `409` `CONFLICT` – idempotency conflict / state conflict
- `422` `VALIDATION_ERROR` – schema validation failed (Pydantic)
- `429` `REGEN_LIMIT_REACHED` – regenerate limit reached
- `500` `INTERNAL_ERROR` – unexpected failure

---

## 1) POST /api/v1/story/generate

Generate a new story draft from the provided child & meal context.

### Request Body
```json
{
  "child_profile": {},
  "meal_context": {},
  "story_config": {},
  "history_context": {}
}
```

**Notes**
- The four objects above should follow your existing MD “input parameters” definitions.
- `history_context` is optional and may be omitted.

### Response 200
```json
{
  "draft": {
    "schema_version": "story-1.0.0",
    "story_id": "st_01H....",
    "generated_at": "2026-02-27T12:34:56Z",
    "book_meta": {
      "title": "string",
      "subtitle": "string",
      "theme_food": "string",
      "story_type": "adventure",
      "target_behavior_level": "Lv2",
      "summary": "string",
      "design_logic": "string",
      "global_visual_style": "string"
    },
    "pages": [
      {
        "page_no": 1,
        "page_id": "p01",
        "behavior_anchor": "Lv1",
        "text": "string",
        "image_prompt": "string",
        "interaction": {
          "type": "tap",
          "instruction": "string",
          "event_key": "tap_cloud",
          "ext": {}
        },
        "branch_choices": [
          {
            "choice_id": "c1",
            "label": "string",
            "next_page_id": "p04"
          }
        ]
      }
    ],
    "ending": {
      "positive_feedback": "string",
      "next_micro_goal": "string"
    },
    "telemetry_suggestions": {
      "recommended_events": ["page_view", "interaction", "story_complete"]
    }
  }
}
```

### Possible Errors
- `422 VALIDATION_ERROR` (input schema invalid)
- `500 INTERNAL_ERROR`

---

## 2) POST /api/v1/story/regenerate

Regenerate a story based on a previous version. Backend must enforce `regen_count < 2`.

### Request Body
```json
{
  "previous_story_id": "st_01H....",
  "target_food": "string",
  "story_type": "adventure",
  "dissatisfaction_reason": "interaction_unclear",
  "dislike_reason": "string (optional)"
}
```

### Response 200
Same shape as `/story/generate`:
```json
{
  "draft": { "...": "same as generate response draft" }
}
```

### Possible Errors
- `404 NOT_FOUND` – `previous_story_id` not found
- `429 REGEN_LIMIT_REACHED` – regen_count already reached max (2)
- `422 VALIDATION_ERROR`
- `500 INTERNAL_ERROR`

---

## 3) POST /api/v1/session/start

Start a reading session for a story draft. Must be idempotent.

### Request Body
```json
{
  "story_id": "st_01H....",
  "client_session_token": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```

### Response 200
```json
{
  "session_id": "ss_01H....",
  "status": "created"
}
```

If the same `(story_id, client_session_token)` is sent again:
```json
{
  "session_id": "ss_01H....",
  "status": "existed"
}
```

### Possible Errors
- `404 NOT_FOUND` – story not found
- `409 CONFLICT` – token reused with different story_id or invalid state
- `422 VALIDATION_ERROR`
- `500 INTERNAL_ERROR`

---

## 4) POST /api/v1/telemetry/report

Batch report telemetry events. The server must de-duplicate by `event_id`.

### Request Body
```json
{
  "events": [
    {
      "event_id": "b6a2c9c6-6f33-4f7f-a8aa-1b0b0ff0a111",
      "schema_version": "telemetry-1.0.0",
      "ts_client_ms": 1760000000123,
      "session_id": "ss_01H....",
      "story_id": "st_01H....",
      "page_id": "p01",
      "event_type": "page_view",
      "payload": {
        "behavior_anchor": "Lv1"
      }
    },
    {
      "event_id": "bb71c23d-8f3a-49d1-9bbd-4e9a58e2c222",
      "schema_version": "telemetry-1.0.0",
      "ts_client_ms": 1760000005678,
      "session_id": "ss_01H....",
      "story_id": "st_01H....",
      "page_id": "p01",
      "event_type": "page_dwell",
      "payload": {
        "duration_ms": 2450
      }
    }
  ]
}
```

### Response 200
Return ingestion stats for client-side retry logic.
```json
{
  "accepted": 2,
  "deduped": 0,
  "rejected": 0
}
```

### Possible Errors
- `422 VALIDATION_ERROR` – malformed events
- `404 NOT_FOUND` – unknown session (optional; many teams choose to still accept)
- `500 INTERNAL_ERROR`

---

## 5) POST /api/v1/feedback/submit

Submit parent feedback after **COMPLETED** or **ABORTED**.

### Request Body (COMPLETED)
```json
{
  "session_id": "ss_01H....",
  "status": "COMPLETED",
  "try_level": "lick",
  "notes": "string (optional)"
}
```

### Request Body (ABORTED)
```json
{
  "session_id": "ss_01H....",
  "status": "ABORTED",
  "abort_reason": "bored",
  "notes": "string (optional)"
}
```

### Response 200
```json
{
  "ok": true
}
```

### Possible Errors
- `404 NOT_FOUND` – session not found
- `422 VALIDATION_ERROR` – missing required conditional fields (try_level/abort_reason)
- `409 CONFLICT` – feedback already submitted (optional constraint)
- `500 INTERNAL_ERROR`

---

## Appendix A: Enumerations (v1)

### BehaviorLevel
- `Lv1` | `Lv2` | `Lv3`

### StoryType (example set)
- `adventure` | `daily_life` | `fantasy` | `animal_friend` | `superhero`

### DissatisfactionReason
- `too_long`
- `too_short`
- `too_scary`
- `too_preachy`
- `not_cute`
- `style_inconsistent`
- `interaction_unclear`
- `repetitive`
- `wrong_age_level`
- `other`

### AbortReason
- `bored` | `scared` | `distracted` | `parent_stopped` | `technical` | `other`

### TryLevel
- `look` | `smell` | `touch` | `lick` | `bite` | `chew` | `swallow`

### Telemetry EventType
- `page_view`
- `page_dwell`
- `interaction`
- `branch_select`
- `story_complete`

---

## Appendix B: Minimal Telemetry Payload Recommendations

- `page_view`: `{ "behavior_anchor": "Lv1" }`
- `page_dwell`: `{ "duration_ms": 1234 }`
- `interaction`: `{ "event_key": "tap_cloud", "latency_ms": 900 }`
- `branch_select`: `{ "choice_id": "c1" }`
- `story_complete`: `{ "completion_rate": 1.0 }`

